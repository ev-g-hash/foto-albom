{% extends 'base.html' %}
{% load static %}

{% block title %}–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ{% endblock %}

{% block content %}
<section class="page">
  <div class="card stack-lg">
    <h2>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h2>
    
    {% if can_upload %}
    <div class="admin-controls">
      <a class="btn" href="{% url 'upload_photos' %}">
        üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
      </a>
    </div>
    {% endif %}
    
    <p class="lead">–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–æ—Ç–æ.</p>

    <ul class="conclusion-list">
      {% for photo in photos %}
      <li>
        <div class="photo-list-item">
          <a href="{% url 'photo_detail' photo.pk %}">
            {{ photo.title|default:"–§–æ—Ç–æ –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }} ‚Äî {{ photo.description|default:"–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è" }}
          </a>
          {% if can_upload %}
          <button class="delete-btn" onclick="deletePhoto({{ photo.pk }}, '{{ photo.title|default:"–§–æ—Ç–æ"|escapejs }}')" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">
            üóëÔ∏è
          </button>
          {% endif %}
        </div>
      </li>
      {% empty %}
      <li>
        <p class="muted">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç.</p>
        {% if can_upload %}
        <a href="{% url 'upload_photos' %}">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ</a>
        {% endif %}
      </li>
      {% endfor %}
    </ul>

    <div class="btn-row">
      <a class="btn" href="{% url 'gallery' %}">–ù–∞—á–∞–ª–æ –≥–∞–ª–µ—Ä–µ–∏</a>
      <a class="btn secondary" href="/">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
  </div>
</section>

<!-- JavaScript –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
<script>
function deletePhoto(photoId, photoTitle) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å "${photoTitle}"?`)) {
        fetch(`/fotos/delete/${photoId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
                const listItem = document.querySelector(`button[onclick="deletePhoto(${photoId}`).closest('li');
                if (listItem) {
                    listItem.remove();
                }
                showMessage(data.message, 'success');
            } else {
                showMessage(data.error, 'error');
            }
        })
        .catch(error => {
            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏', 'error');
        });
    }
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function showMessage(text, type) {
    // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let messagesContainer = document.querySelector('.messages');
    if (!messagesContainer) {
        messagesContainer = document.createElement('div');
        messagesContainer.className = 'messages';
        document.querySelector('.card').insertBefore(messagesContainer, document.querySelector('.lead').nextSibling);
    }
    
    const message = document.createElement('div');
    message.className = `message ${type}`;
    message.textContent = text;
    messagesContainer.appendChild(message);
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (message.parentNode) {
            message.remove();
        }
    }, 5000);
}
</script>
{% endblock %}